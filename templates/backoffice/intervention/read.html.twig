{% extends 'backoffice/base.html.twig' %}

{% block title %}Intervention n°{{ i.ref_number }} enregistrée le {{ i.created_at | format_date('none', 'EEEE d MMM Y', null, 'gregorian', 'fr') }}{% endblock %}

{% block aside %}
    {{ include('backoffice/intervention/_aside.html.twig') }}
{% endblock %}

{% block body %}
    <div class="grid-12">
        <div class="col-9_sm-12">
            {% if i.equipment_name != i.e_name %}
                <div class="grid-12">
                    <div class="col-12_sm-12">
                        <div class="alert alert-info" id="alert-ajax">
                            <strong>Information</strong> : le nom de l'équipement de cette intervention ne correspond pas avec l'association "Equipment". Cliquez ci-dessous afin de mettre à jour les données.
                            <form method="post" action="#" id="update-equipment-name" class="mt-2">
                                <button type="button" onclick="ajaxUpdateDataUrl('{{ url_for('intervention_ajax_u_equipment_name', {'id' : intervention_id, 'eid': i.equipments_id}) }}', 'update-equipment-name'); return false;" class="btn-sm btn-light-info submit-ajax">Mettre à jour maintenant</button>
                                <span id="message"></span>
                            </form>
                        </div>
                    </div>
                </div>
            {% endif %}
            <div class="grid-12">
                <div class="col-4_sm-12">
                    <!-- Actions -->
                    <div class="mb-3">
                        <button type="button" data-target="update_intervention" data-toggle="modal" class="btn btn-light-info mb-0"> <i class="ri-settings-2-line"></i> Editer</button>
                        <button type="button" data-target="update_intervention" data-toggle="modal" class="btn btn-light-warning mb-0"> <i class="ri-settings-2-line"></i> Révoquer</button>
                    </div>
                    <div class="card {% if i.state == 'DRAFT' %}card-light-yellow{% else %}card-light-purple{% endif %}">
                        <div class="card-body p-3">
                            {% if i.state == 'DRAFT' %}
                                <a href="#" class="label badge-light-yellow d-inline-block mb-3"><i class="ri-checkbox-circle-line"></i> Valider cette intervention</a>
                            {% endif %}
                            <div>
                                <span class="fw-500 d-block mb-1">Statut de l'intervention</span>
                                <div class="flex label-twin">
                            <span class="lt-button">
                                <button type="button" class="btn-sm btn-light-purple">Mettre à jour</button>
                            </span>
                                    <span class="lt-text">
                                {{ i.updated_at | format_date('none', 'EEEE d MMM Y', null, 'gregorian', 'fr') }}
                            </span>
                                </div>
                            </div>
                            <div class="mt-4">
                                <span class="fw-500 d-block mb-1">Date de dépôt</span>
                                <div class="flex label-twin">
                            <span class="lt-button">
                                <button type="button" class="btn-sm btn-light-purple">Changer</button>
                            </span>
                                    <span class="lt-text">
                                {{ form.inputDate('deposit_date', false) | raw }}
                            </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /Actions -->
                </div>
                <div class="col-8_sm-12">
                    <div class="grid-12">
                        <!-- Customer -->
                        <div class="col-6_sm-12">
                            <div class="card mb-3">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center border-bottom-dashed pb-2">
                                        <div class="mr-3"><i class="ri-user-fill fs-32px"></i></div>
                                        <div>
                                            <h3>{{ i.customer_name }}</h3>
                                            <span class="d-block">{{ i.zipcode }} - {{ i.city }}</span>
                                            <span class="d-block">{{ i.department }}</span>
                                            <span class="d-block"><strong>{{ i.phone }}</strong> / <strong>{{ i.mobile }}</strong></span>
                                        </div>
                                    </div>
                                    <div class="pt-2">
                                        <div class="flex align-items-center justify-content-space-between">
                                            <div>Préférence de contact</div>
                                            <div class="text-right fw-600">{{ i.favorite_contact }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /Customer -->
                        <!-- Company -->
                        <div class="col-6_sm-12">
                            <div class="card mb-3">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-center border-bottom-dashed pb-2">
                                        <div class="mr-3"><i class="ri-building-fill fs-32px"></i></div>
                                        <div>
                                            <h3>{{ i.cy_name }}</h3>
                                            <span class="d-block">{{ i.cy_address }}</span>
                                            <span class="d-block">{{ i.cy_zipcode }} - {{ i.cy_city }}</span>
                                            <span class="d-block">{{ i.cy_department }}</span>
                                            <span class="d-block"><strong>{{ i.cy_phone }}</strong></span>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center mt-3">
                                        <div class="user-avatar mr-3">
                                            {% if i.u_avatar is not null and i.u_avatar is not empty %}
                                                <img class="img-responsive rounded-circle" style="width: 60px;height: auto" src="/uploads/avatars/{{ i.u_id }}/{{ i.u_avatar }}" alt="">
                                            {% else %}
                                                <img class="img-responsive" style="width: 60px;height: auto" src="/assets/no-avatar-120x120.jpg" alt="">
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h3 class="mb-1">{{ i.u_fullname }}</h3> Technicien
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- /Company -->
                    </div>
                    <!-- Intervention details -->
                    <div class="card mb-3">
                        <div class="card-body p-4">
                            <div class="form-group">
                                <input type="text" class="form-input" value="{{ i.name }}" readonly>
                            </div>
                            <div class="grid-12">
                                <div class="col-6_sm-12">
                                    <div class="form-group">
                                        <label>
                                            <textarea class="form-input" readonly>{{ i.description }}</textarea>
                                        </label>
                                    </div>
                                    {{ form.textarea('description', false, false) | raw }}
                                </div>
                                <div class="col-3_sm-12">
                                    <strong class="d-block mb-2">Débutée le</strong>
                                    {% if i.start_date is not null %}
                                        <span class="d-inline-block fs-13px fw-500 bg-light-info pt-1 pb-1 pr-2 pl-2 text-uppercase">
                                        {{ i.start_date | format_date('none', 'd MMM Y', null, 'gregorian', 'fr') }}
                                    </span>
                                    {% else %}
                                        <form method="post" action="" id="start-intervention">
                                        <button type="button" onclick="ajaxUpdateDataUrl('{{ url_for('intervention_ajax_start', {'id' : intervention_id}) }}', 'start-intervention'); return false;" class="btn-sm badge-light-green submit-ajax">Commencer maintenant !</button>
                                        <span id="sync-start"></span>
                                        </form>
                                    {% endif %}
                                </div>
                                <div class="col-3_sm-12">
                                    <strong class="d-block mb-2">Terminée le</strong>
                                    {% if i.end_date is not null %}
                                        <span class="d-inline-block fs-13px fw-500 alert-light-pink pt-1 pb-1 pr-2 pl-2 text-uppercase">
                                        {{ i.end_date | format_date('none', 'd MMM Y', null, 'gregorian', 'fr') }}
                                    </span>
                                    {% else%}
                                        <form method="post" action="" id="end-intervention">
                                        <button type="button" onclick="ajaxUpdateDataUrl('{{ url_for('intervention_ajax_end', {'id' : intervention_id}) }}', 'end-intervention'); return false;" class="btn-sm badge-light-green submit-ajax">Mettre fin maintenant !</button>
                                        <span id="sync-end"></span>
                                        </form>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="border-top-dashed mt-1 mb-3"></div>
                            <div class="grid-12">
                                <div class="col-3_sm-12">
                                    <strong class="d-block mb-2">Equipement</strong>
                                    <a class="btn-sm btn-light-primary" href="{{ url_for('equipment_read', {id:i.equipments_id}) }}"><i class="ri-pencil-fill"></i> {{ i.equipment_name }}</a>
                                </div>
                                <div class="col-3_sm-12">
                                    <strong class="d-block mb-2">Priorité</strong>
                                    {{ getDataPriority(i.a_priority) }}
                                </div>
                                <div class="col-3_sm-12">
                                    <strong class="d-block mb-2">Type d'intervention</strong>
                                    {{ i.sort }}
                                </div>
                                <div class="col-3_sm-12">
                                    <strong class="d-block mb-2">Lien vers l'intervention</strong>
                                    <a class="btn-sm btn-light-primary" href="{{ url_for('app_read_intervention', {ref_for_link:i.ref_for_link}) }}" target="_blank">#{{ i.ref_number }}</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /Intervention details -->
                </div>
            </div>
        </div>
        <div class="col-3_sm-12">
            <!-- Tasks -->
            <div class="card">
                <div class="card-body p-4">
                    <span class="d-block fw-500 mb-3">Gestion des tâches</span>
                    <div class="mb-3">
                        <em>Si une tâche n'existe pas, ajoutez-la ci-dessous.</em>
                    </div>
                    <form method="post" action="">
                        <div class="flex label-twin label-twin-left-btn mb-3">
                                <span class="lt-text">
                                    <label for="name">
                                        <input type="text" class="form-input-twin" id="name" name="name" placeholder="Nom de la tâche">
                                    </label>
                                </span>
                            <span class="lt-button">
                                    <button type="submit" class="btn-sm btn-light-purple">Créer la tâche</button>
                                </span>
                        </div>
                    </form>
                    <div class="mb-3">
                        <em>Vous pouvez selectionner plusieurs tâches à la fois depuis ce sélecteur.</em>
                    </div>
                    {{ formTasks.renderStart | raw }}
                    <div class="select2">
                        {{ formTasks.renderField('tasks') | raw }}
                    </div>
                    <div class="flex align-items-center justify-content-space-between">
                        <div class="text-right flex-root">
                            <button type="submit" class="btn-sm btn-light-purple">Mettre à jour</button>
                        </div>
                    </div>
                    {{ formTasks.renderEnd(false) | raw }}
                    <div class="tasks-list mt-3">
                        <span class="d-block fw-500 mb-3">Tâche(s) enregistrée(s)</span>
                        <ul>
                            {% for t in tForI %}
                                <li data-task-id="{{ t.id }}">
                                    <form class="flex align-items-center justify-content-space-between" method="post" action="{{ url_for('task_delete_intervention', {'id':intervention_id, 'task': t.id}) }}">
                                        <input type="hidden" name="task_id" value="{{ t.id }}">
                                        <span>{{ t.name }}</span>
                                        <button type="submit" class="label-mid badge-light-pink">x</button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <!-- /Tasks -->
        </div>
    </div>
    <div>
    </div>
    {{ include('backoffice/intervention/_modal/_update_fields.html.twig') }}
{% endblock %}

{% block javascripts %}
    <script src="/assets/js/functions.interventions.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js" integrity="sha512-2ImtlRlf2VVmiGZsjm9bEyhjGW4dU7B6TNwh/hx/iSByxNENtj3WVE6o/9Lj4TJeVXPi4bnOIMXFIJJAeufa0A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" integrity="sha512-nMNlpuaDPrqlEls3IX/Q56H36qvBASwb3ipuo3MxeWbsQB1881ox0cRv7UPTgBlriqoynt35KjEwgGUeUXIPnw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>
        $(document).ready(function() {
            $('#form_tasks-tasks').select2();
        });
    </script>
{% endblock %}